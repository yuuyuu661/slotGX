<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #0c1b2a;
      color: #fff;
    }
    .slot-container {
      display: flex;
      justify-content: center;
      margin-top: 50px;
      overflow: hidden;
      width: 650px;
      height: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .reel-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 2px;
    }
    .reel {
      width: 100px;
      height: 400px;
      overflow: hidden;
      background: #222;
      border: 3px solid gold; /* ‚Üê „Åì„Åì„Çí gold „Å´Â§â„Åà„Çã */
      box-shadow: 0 0 10px gold; /* ÂÖâ„Çâ„Åõ„Åü„ÅÑ„Å®„Åç */
    }
    .symbols {
      position: relative;
      top: 0;
      width: 100%;
    }
    .symbol {
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .symbol.highlight {
      border: 2px solid yellow;
      background-color: rgba(255,255,0,0.2);
      border-radius: 8px;
    }
    .stop-btn, #start {
      font-size: 16px;
      padding: 5px 10px;
      margin-top: 5px;
    }
    #payoutTable {
      width: 90%;
      max-width: 700px;
      margin: 20px auto 0 auto;
      display: block;
      border: 2px solid gold;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.5);
      transition: opacity 0.5s ease;
    }
    #start {
      font-size: 24px;
      margin-top: 30px;
    }
    #coinDisplay {
      margin-top: 20px;
      font-size: 18px;
    }
    .coin {
      position: fixed;
      top: -60px;
      width: 40px;
      height: 40px;
      pointer-events: none;
      animation: fall 1.5s linear forwards;
      z-index: 1000;
    }

    @keyframes fall {
      to {
      top: 100%;
      transform: rotate(360deg);
      opacity: 0;
  }
}
  </style>
</head>
<body>
  <audio id="winSound" src="sounds/win.mp3" preload="auto"></audio>
  <audio id="loseSound" src="sounds/lose.mp3" preload="auto"></audio>
  <audio id="win3Sound" src="sounds/win3.mp3" preload="auto"></audio>
  <audio id="win4Sound" src="sounds/win4.mp3" preload="auto"></audio>
  <audio id="win5Sound" src="sounds/win5.mp3" preload="auto"></audio>
  <audio id="startSound" src="sounds/start.mp3" preload="auto"></audio>
  <audio id="stopSound" src="sounds/stop.mp3" preload="auto"></audio>
  <audio id="bgmNormal" src="sounds/bgm_normal.mp3" loop preload="auto"></audio>
  <audio id="bgmBonus" src="sounds/bgm_bonus.mp3" loop preload="auto"></audio>
  <img src="images/payout_table.png" alt="„Éö„Ç§„ÉÜ„Éº„Éñ„É´" id="payoutTable">
  <div class="slot-container" id="slotContainer"></div>
  <button id="start">„Çπ„Çø„Éº„ÉàÔºÅ</button>
  <button id="cashoutBtn">Ê∏ÖÁÆó</button>
  <div id="coinDisplay">ÊâÄÊåÅ„Ç≥„Ç§„É≥: <span id="coins">100</span></div>
<div id="volumeControl" style="margin-top: 15px;">
  üîä BGMÈü≥Èáè: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
</div>
  <div id="result"></div>

  <script>
    const symbols = [
      { name: "seven", src: "images/seven.png", bonus: false },
      { name: "orb", src: "images/orb.png", bonus: true },
      { name: "slime", src: "images/slime.png", bonus: false },
      { name: "lemon", src: "images/lemon.png", bonus: false },
      { name: "grape", src: "images/grape.png", bonus: false },
      { name: "bell", src: "images/bell.png", bonus: false },
      { name: "gem", src: "images/gem.png", bonus: false }
    ];

    const symbolWeights = [6, 6, 10, 12, 18, 20, 28];
    const payoutTable = {
    "seven": { 3: 50, 4: 250, 5: 500 },
    "gem":{ 3: 30, 4: 150, 5: 300 },
    "bell":  { 3: 10, 4: 50, 5: 100 },
    "grape": { 3: 5,  4: 25, 5: 50 },
    "lemon": { 3: 3,  4: 15, 5: 30 },
    "slime": { 3: 2,  4: 10, 5: 20 }
    };
    const reels = [];
    const reelCount = 5;
    const rowsVisible = 3;
    const coinsEl = document.getElementById("coins");
    const resultEl = document.getElementById("result");
    const startBtn = document.getElementById("start");
    const slotContainer = document.getElementById("slotContainer");
    const winSound = document.getElementById("winSound");
    const loseSound = document.getElementById("loseSound");
    const bgmNormal = document.getElementById("bgmNormal");
    const bgmBonus  = document.getElementById("bgmBonus");
    const volumeSlider = document.getElementById("volumeSlider");
    const startSound = document.getElementById("startSound");
    const stopSound = document.getElementById("stopSound");
    bgmNormal.loop = true;
    bgmBonus.loop = true;
    let hasChecked = false; // ÂΩì„Åü„Çä„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„Åã„Å©„ÅÜ„Åã

    bgmNormal.volume = 0.5;
    bgmBonus.volume = 0.5;

    let coins = 100;
    let spinningFlags = [];
    let bonusSpins = 0;
    let inBonus = false;

    // Create reel elements
    for (let i = 0; i < reelCount; i++) {
      const wrapper = document.createElement("div");
      wrapper.className = "reel-wrapper";
      const reel = document.createElement("div");
      reel.className = "reel";
      const symbolsDiv = document.createElement("div");
      symbolsDiv.className = "symbols";
      reel.appendChild(symbolsDiv);
      wrapper.appendChild(reel);

      const btn = document.createElement("button");
      btn.className = "stop-btn";
      btn.textContent = "STOP";
      btn.dataset.index = i;
      wrapper.appendChild(btn);

      slotContainer.appendChild(wrapper);
      reels.push(reel);
    }
    window.addEventListener("load", () => {
      bgmNormal.volume = 0.1; // Èü≥ÈáèË™øÊï¥Ôºà0.0„Äú1.0Ôºâ
      bgmBonus.volume = 0.1;

      // Ëá™ÂãïÂÜçÁîü„Éà„É©„Ç§ÔºàÂ§±Êïó„Åó„Åü„Çâ„ÇØ„É™„ÉÉ„ÇØÂæÖ„Å°Ôºâ
      bgmNormal.play().catch(() => {
    document.body.addEventListener("click", () => {
      bgmNormal.play();
    }, { once: true });
  });
});
const API_BASE = "https://bo4-production.up.railway.app";

async function fetchSessionData() {
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session');
  if (!sessionId) {
    alert("„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");
    return;
  }

   try {
    const response = await fetch(`${API_BASE}/api/session?session=${sessionId}`);
    if (!response.ok) {
      throw new Error("„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØÊúüÈôêÂàá„Çå„Åß„Åô„ÄÇ");
    }


   const data = await response.json();
    coins = data.coins;
    coinsEl.textContent = coins;
    console.log("„Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„ÇøÂèñÂæó:", data);
  } catch (err) {
    alert("„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºö" + err.message);
  }
}

window.addEventListener("DOMContentLoaded", () => {
  fetchSessionData();
});    
    function getRandomSymbol() {
      const total = symbolWeights.reduce((a, b) => a + b);
      let rand = Math.random() * total, acc = 0;
      for (let i = 0; i < symbols.length; i++) {
        acc += symbolWeights[i];
        if (rand < acc) return symbols[i];
      }
      return symbols[symbols.length - 1];
    }

    function createSymbolDiv(symbol) {
      const div = document.createElement("div");
      div.className = "symbol";
      const img = document.createElement("img");
      img.src = inBonus && !symbol.bonus ? symbol.src.replace('.png', '_bonus.png') : symbol.src;
      img.alt = symbol.name;
      img.style.width = "80px";
      img.style.height = "80px";
      div.appendChild(img);
      return div;
    }

    function setupReels() {
      reels.forEach(reel => {
        const container = reel.querySelector('.symbols');
        container.innerHTML = '';
        for (let i = 0; i < 20; i++) container.appendChild(createSymbolDiv(getRandomSymbol()));
        container.style.top = "0px";
      });
    }

    function startReel(index) {
      const container = reels[index].querySelector('.symbols');
      let pos = 0, speed = 20, slowing = false;

      function animate() {
        pos += speed;
        if (pos >= 100) {
          container.appendChild(createSymbolDiv(getRandomSymbol()));
          container.removeChild(container.firstElementChild);
          pos -= 100;
        }
        container.style.top = -pos + "px";
        if (!spinningFlags[index]) {
          if (!slowing) slowing = true;
          speed *= 0.92;
          if (speed <= 1) {
            const aligned = Math.round(pos / 100) * 100;
            container.style.top = -aligned + "px";
            return;
          }
        }
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }

    function getVisibleSymbols() {
      const visible = [[], [], []];
      reels.forEach((reel, col) => {
        const container = reel.querySelector('.symbols');
        const top = parseFloat(container.style.top) || 0;
        const offset = Math.round(-top / 100);
        const symbolsEls = container.children;
        for (let row = 0; row < rowsVisible; row++) {
          const el = symbolsEls[offset + row];
          visible[row][col] = el?.querySelector("img")?.alt || '';
        }
      });
      return visible;
    }
    volumeSlider.addEventListener("input", () => {
      const vol = parseFloat(volumeSlider.value); // 0.00„Äú1.00 „ÅÆÂÄ§
      bgmNormal.volume = vol;
      bgmBonus.volume = vol;
    });

    function checkWinLines() {
  const visible = getVisibleSymbols();
  const results = [];
  const highlightMap = [];
  let orbCount = 0;
  let totalWin = 0;

  visible.forEach((line, rowIdx) => {
    for (let start = 0; start <= 2; start++) {
      const symbol = line[start];
      let count = 1;
      for (let i = start + 1; i < reelCount && line[i] === symbol; i++) count++;

      if (count >= 3) {
        results.push({ row: rowIdx, symbol, count });

        // „Éè„Ç§„É©„Ç§„Éà
        for (let i = start; i < start + count; i++) {
          highlightMap.push({ row: rowIdx, col: i });
        }

        const payout = payoutTable[symbol]?.[count] || 0;
        totalWin += payout;

        if (symbol === 'orb') orbCount = count;
        break;
      }
    }
  });

  highlightMap.forEach(({ row, col }) => {
    const container = reels[col].querySelector('.symbols');
    const top = parseFloat(container.style.top) || 0;
    const offset = Math.round(-top / 100);
    const symbolEl = container.children[offset + row];
    if (symbolEl) symbolEl.classList.add("highlight");
  });

 if (totalWin > 0) {
  // ÊúÄ„ÇÇÂ§ß„Åç„ÅÑÊèÉ„ÅÑÊï∞„ÇíÂèñÂæó
  const maxCount = Math.max(...results.map(r => r.count));
  dropCoins(100); 
  setTimeout(() => {
    if (maxCount >= 5) {
      win5Sound.currentTime = 0;
      win5Sound.play();
    } else if (maxCount === 4) {
      win4Sound.currentTime = 0;
      win4Sound.play();
    } else {
      win3Sound.currentTime = 0;
      win3Sound.play();
    }
  }, 100);

  coins += totalWin * (inBonus ? 2 : 1);
  resultEl.textContent = results.map(r => `„Äå${['‰∏ä','‰∏≠','‰∏ã'][r.row]}ÊÆµ:${r.symbol}x${r.count}„Äç`).join(' / ') + `Ôºà${totalWin}„Ç≥„Ç§„É≥Ôºâ`;
} else {
  setTimeout(() => {
    loseSound.currentTime = 0;
    loseSound.play();
  }, 100);
  resultEl.textContent = "„Éè„Ç∫„É¨...";
}

  coinsEl.textContent = coins;

 if (orbCount >= 3 && !inBonus) {
  bonusSpins = orbCount;
  inBonus = true;

  // BGMÂàá„ÇäÊõø„Åà
  bgmNormal.pause();
  bgmBonus.currentTime = 0;
  bgmBonus.play();

  // UIÊõ¥Êñ∞
  document.getElementById("payoutTable").src = "images/payout_table_bonus.png";
  alert("„Éú„Éº„Éä„Çπ„Çø„Ç§„É†ÈñãÂßãÔºÅ " + bonusSpins + "Âõû");
 }
}


    function stopReel(index) {
    stopSound.currentTime = 0;
    stopSound.play();
  spinningFlags[index] = false;

  if (spinningFlags.every(flag => !flag) && !hasChecked) {
    hasChecked = true; // ‰∏ÄÂ∫¶„Å†„ÅëÂà§ÂÆö„Åô„Çã
    setTimeout(() => {
      checkWinLines();

      // „Éú„Éº„Éä„Çπ„Çπ„Éî„É≥„Çí1„Å§Ê∂àË≤ª
      if (bonusSpins > 0) {
        bonusSpins--;
      }

      // „Éú„Éº„Éä„ÇπÁµÇ‰∫ÜÂá¶ÁêÜ
      if (bonusSpins <= 0 && inBonus) {
        inBonus = false;

        // „Éú„Éº„Éä„ÇπBGM„ÇíÊ≠¢„ÇÅ„Å¶„ÄÅÈÄöÂ∏∏BGM„ÇíÂÜçÁîü
        bgmBonus.pause();
        bgmNormal.currentTime = 0;
        bgmNormal.play();

        // „Éö„Ç§„ÉÜ„Éº„Éñ„É´ÁîªÂÉè„ÇíÂÖÉ„Å´Êàª„Åô
        document.getElementById("payoutTable").src = "images/payout_table.png";

        alert("„Éú„Éº„Éä„Çπ„Çø„Ç§„É†ÁµÇ‰∫ÜÔºÅ");
      }

    }, 500);
  }
}
function dropCoins(amount = 20) {
      for (let i = 0; i < amount; i++) {
        const coin = document.createElement("img");
        coin.src = "images/coin.png";
       coin.className = "coin";
        coin.style.left = Math.random() * window.innerWidth + "px";
        coin.style.animationDelay = (Math.random() * 0.5) + "s";
        document.body.appendChild(coin);

        setTimeout(() => {
      coin.remove();
    }, 2000); // Ê∂àÂéª
  }
}
     document.getElementById("cashoutBtn").addEventListener("click", async () => {
  const sessionId = new URLSearchParams(window.location.search).get("session");
  const coinsToCashout = coins;
  const cashoutBtn = document.getElementById("cashoutBtn");

  if (!sessionId) {
    alert("„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇURL„Å´ ?session=xxx „ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
    return;
  }

  // üîí „Éú„Çø„É≥„Çí‰∏ÄÂ∫¶„Å†„ÅëÊäº„Åõ„Çã„Çà„ÅÜ„Å´Âà∂Âæ°
  cashoutBtn.disabled = true;
  cashoutBtn.textContent = "ÈÄÅ‰ø°‰∏≠...";

  try {
    const res = await fetch(`${API_BASE}/api/cashout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session: sessionId, coins: coinsToCashout })
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData?.error || "„Çµ„Éº„Éê„Éº„Ç®„É©„Éº");
    }

    alert(`‚úÖ Ê∏ÖÁÆó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÔºà${coinsToCashout} SptÔºâ\n„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÊâãÂãï„ÅßÈñâ„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
    cashoutBtn.textContent = "‚úÖ ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü";
  } catch (err) {
    alert("‚ùå Ê∏ÖÁÆó„Ç®„É©„Éº: " + err.message);
    cashoutBtn.disabled = false;
    cashoutBtn.textContent = "Ê∏ÖÁÆó";
  }
});
    document.querySelectorAll('.stop-btn').forEach(btn => {
      btn.addEventListener('click', () => stopReel(+btn.dataset.index));
    });

    startBtn.addEventListener("click", () => {
      if (spinningFlags.some(f => f)) return;
      hasChecked = false; // ‚Üê„Åì„Åì„Åß„É™„Çª„ÉÉ„Éà
      if (!inBonus && coins < 10) return resultEl.textContent = "„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ";
  
       startSound.currentTime = 0;
       startSound.play();
      if (!inBonus) coins -= 10;
      coinsEl.textContent = coins;
      resultEl.textContent = "";
      setupReels();
      spinningFlags = Array(reelCount).fill(true);
      for (let i = 0; i < reelCount; i++) startReel(i);
    });

    setupReels();
  </script>
<script>
window.Coins = {
  async get(){ const r = await fetch('/api/coins', {credentials:'include'}); const j = await r.json(); return BigInt(j.coins); },
  async credit(n, reason='payout'){
    const r = await fetch('/api/coins/credit', {method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({amount: Number(n), reason})});
    if(!r.ok) throw new Error((await r.json()).error||'credit error');
    return (await r.json()).coins;
  },
  async debit(n, reason='bet'){
    const r = await fetch('/api/coins/debit', {method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({amount: Number(n), reason})});
    if(!r.ok) throw new Error((await r.json()).error||'debit error');
    return (await r.json()).coins;
  }
};
</script></body>
</html>

