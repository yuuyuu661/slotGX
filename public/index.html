<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Slot Machine — Login</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .login { max-width: 360px; margin: 80px auto; border: 1px solid #ccc; padding: 16px; border-radius: 12px; }
    .row { display: grid; gap: 8px; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .hidden { display:none; }
    #err { color: red; }
  </style>
</head>
<body>
  <div class="login">
    <h2>ログイン</h2>
    <div class="row">
      <label>ユーザー名 <input id="username" autocomplete="username" /></label>
      <label>パスワード <input id="password" type="password" autocomplete="current-password" /></label>
    </div>
    <div class="toolbar">
      <button id="loginBtn">ログイン</button>
    </div>
    <p id="err" class="hidden"></p>
    <p style="font-size:12px;opacity:.75">ログイン後にスロット画面へ移動します。</p>
  </div>
<button id="checkBackend" style="display:block;margin:0 auto 12px;">接続テスト</button>
<script>

async function api(path, opts={}){
  // Quick ping to backend if needed

  const res = await fetch(path, { credentials:'include', headers:{'content-type':'application/json'}, ...opts });
  if(!res.ok){ let e='error'; try{ e=(await res.json()).error }catch{}; throw new Error(e); }
  return res.json();
}
document.getElementById('checkBackend').addEventListener('click', async ()=>{
  const err = document.getElementById('err');
  try{ const r = await fetch('/debug/db', {credentials:'include'}); const j = await r.json(); err.textContent = 'DB接続: ' + (j.ok?'OK':'NG'); err.classList.remove('hidden'); }catch(e){ err.textContent = '接続エラー: ' + (e.message||e); err.classList.remove('hidden'); }
});

document.getElementById('loginBtn').addEventListener('click', async () => {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  const err = document.getElementById('err');
  err.classList.add('hidden');
  try{
    await api('/api/login', { method:'POST', body: JSON.stringify({ username:u, password:p }) });
    // fetch coins once to ensure session, then go to user slot index
    const coins = await api('/api/coins');
    // target URL injected below
    location.href = '/slot-main/public/index.html?enter=1';
  }catch(e){
    err.textContent = e.message || 'ログインに失敗しました';
    err.classList.remove('hidden');
  }
});
</script>
</body>
</html>
